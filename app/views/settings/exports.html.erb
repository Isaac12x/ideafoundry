<div class="settings-container">
  <div class="page-header">
    <h2>Export & Backup</h2>
    <%= link_to settings_path, class: "btn btn-sm" do %>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      Back to Settings
    <% end %>
  </div>

  <div class="scoring-config-layout">
    <div class="scoring-config-main">
      <div class="config-section">
        <h3>Create Export</h3>
        <p class="config-description">
          Export all your ideas, lists, topologies, and settings as a compressed archive.
          Optionally protect the export with a password.
        </p>

        <% if @active_export %>
          <div class="export-status-banner processing">
            <strong><%= @active_export.pending? ? "Export queued..." : "Export in progress..." %></strong>
            <span><%= @active_export.progress %>%</span>
            <div class="export-progress-bar">
              <div class="export-progress-fill" style="width: <%= @active_export.progress %>%"></div>
            </div>
          </div>
        <% else %>
          <%= form_with url: settings_exports_path, method: :post, local: true do |f| %>
            <div class="weight-grid">
              <div class="weight-item" style="grid-column: 1 / -1;">
                <label class="weight-label">Password Protection (optional)</label>
                <span class="weight-description">If set, the export will be a password-protected ZIP. Minimum 8 characters.</span>
                <div class="weight-input-group">
                  <input type="password"
                         name="password"
                         class="weight-input"
                         style="text-align: left;"
                         placeholder="Leave blank for unprotected .tar.gz"
                         minlength="8">
                </div>
              </div>
            </div>

            <div class="config-actions">
              <%= f.submit "Start Export", class: "btn btn-primary" %>
            </div>
          <% end %>
        <% end %>
      </div>

      <% if @export_jobs.any? %>
        <div class="config-section" style="margin-top: 2rem;">
          <h3>Export History</h3>
          <p class="config-description">Recent exports. Downloads are available for 7 days.</p>

          <div class="export-history">
            <% @export_jobs.each do |job| %>
              <div class="export-row">
                <div class="export-row-info">
                  <span class="export-date"><%= job.created_at.strftime("%b %d, %Y at %l:%M %p") %></span>
                  <span class="export-badge <%= job.status %>"><%= job.status.capitalize %></span>
                  <span class="export-badge <%= job.kind %>"><%= job.kind.capitalize %></span>
                  <% if job.password_protected? %>
                    <span class="export-badge protected">Protected</span>
                  <% end %>
                  <% if job.completed? && job.file_exists? %>
                    <span class="export-meta"><%= job.file_size_human %></span>
                  <% end %>
                  <% if job.duration_human %>
                    <span class="export-meta"><%= job.duration_human %></span>
                  <% end %>
                  <% if job.error_message.present? %>
                    <span class="export-error"><%= job.error_message %></span>
                  <% end %>
                </div>
                <div class="export-row-actions">
                  <% if job.completed? && job.file_exists? %>
                    <%= link_to "Download", settings_export_download_path(job), class: "btn btn-sm btn-primary" %>
                  <% end %>
                  <%= button_to "Delete", settings_export_destroy_path(job), method: :delete, class: "btn btn-sm btn-danger", data: { turbo_confirm: "Delete this export?" } %>
                </div>
              </div>
            <% end %>
          </div>

          <% if @export_jobs.size >= 3 %>
            <div class="config-actions" style="margin-top: 1rem;">
              <%= button_to "Clean Up Old Exports", settings_exports_cleanup_path, method: :post, class: "btn btn-secondary btn-sm" %>
            </div>
          <% end %>
        </div>
      <% end %>

      <div class="config-section" style="margin-top: 2rem;">
        <h3>Backup Schedule</h3>
        <p class="config-description">
          Configure automatic backups. Scheduled backups run daily at 2 AM and follow your frequency setting.
        </p>

        <%= form_with url: settings_backup_path, method: :patch, local: true do |f| %>
          <div class="weight-grid">
            <div class="weight-item">
              <label class="weight-label">Frequency</label>
              <span class="weight-description">How often to create automatic backups</span>
              <select name="backup_settings[frequency]" class="weight-input" style="text-align: left;">
                <% %w[never daily weekly monthly].each do |freq| %>
                  <option value="<%= freq %>" <%= 'selected' if @backup_settings['frequency'] == freq %>><%= freq.capitalize %></option>
                <% end %>
              </select>
            </div>

            <div class="weight-item">
              <label class="weight-label">Retention (days)</label>
              <span class="weight-description">Delete backups older than this</span>
              <input type="number" name="backup_settings[retention_days]" class="weight-input"
                     value="<%= @backup_settings['retention_days'] %>" min="1" max="365">
            </div>

            <div class="weight-item">
              <label class="weight-label">Max Backups</label>
              <span class="weight-description">Keep at most this many backups</span>
              <input type="number" name="backup_settings[max_backups]" class="weight-input"
                     value="<%= @backup_settings['max_backups'] %>" min="1" max="100">
            </div>

            <div class="weight-item">
              <label class="weight-label">Auto Cleanup</label>
              <span class="weight-description">Automatically delete old backups after scheduled runs</span>
              <select name="backup_settings[auto_cleanup]" class="weight-input" style="text-align: left;">
                <option value="true" <%= 'selected' if @backup_settings['auto_cleanup'].to_s == 'true' %>>Enabled</option>
                <option value="false" <%= 'selected' if @backup_settings['auto_cleanup'].to_s == 'false' %>>Disabled</option>
              </select>
            </div>

            <div class="weight-item">
              <label class="weight-label">Email Notification</label>
              <span class="weight-description">Send email after each scheduled backup completes</span>
              <select name="backup_settings[email_notification]" class="weight-input" style="text-align: left;">
                <option value="true" <%= 'selected' if @backup_settings['email_notification'].to_s == 'true' %>>Enabled</option>
                <option value="false" <%= 'selected' if @backup_settings['email_notification'].to_s == 'false' %>>Disabled</option>
              </select>
            </div>
          </div>

          <div class="config-actions">
            <%= f.submit "Save Backup Settings", class: "btn btn-primary" %>
            <% if @active_backup %>
              <span class="btn btn-secondary" disabled>Backup in progress...</span>
            <% else %>
              <%= button_to "Backup Now", settings_backup_now_path, method: :post, class: "btn btn-secondary" %>
            <% end %>
          </div>
          <% if @last_backup %>
            <p class="config-description" style="margin: 0.75rem 0 0;">
              Last backup: <%= time_ago_in_words(@last_backup.created_at) %> ago
            </p>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="scoring-config-sidebar">
      <div class="config-info-card">
        <h4>What's Included</h4>
        <ul>
          <li>All ideas with scores, metrics, and descriptions</li>
          <li>Lists and idea ordering</li>
          <li>Topologies and hierarchies</li>
          <li>Templates and custom fields</li>
          <li>Scoring weights and settings</li>
        </ul>
      </div>

      <div class="config-info-card">
        <h4>Export Format</h4>
        <p>Without a password, exports are <code>.tar.gz</code> archives. With a password, exports are encrypted <code>.zip</code> files.</p>
        <p>Exports older than 7 days are automatically eligible for cleanup.</p>
      </div>

      <div class="config-info-card">
        <h4>Scheduled Backups</h4>
        <p>When enabled, backups run automatically at 2 AM. Choose <strong>daily</strong>, <strong>weekly</strong> (Mondays), or <strong>monthly</strong> (1st of month).</p>
        <p>Old backups are cleaned up based on your retention and max backup settings.</p>
      </div>
    </div>
  </div>
</div>
