<% if topology.errors.any? %>
  <div class="alert alert-error">
    <h4><%= pluralize(topology.errors.count, "error") %> prohibited this topology from being saved:</h4>
    <ul>
      <% topology.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="form-dashboard-row">
  <div class="form-panel">
    <h3 class="form-panel-title">Details</h3>

    <div class="form-group">
      <%= form.label :name %>
      <%= form.text_field :name, class: "form-control", required: true, placeholder: "e.g., SaaS, Hardware, Mobile App" %>
    </div>

    <div class="form-group">
      <%= form.label :parent_id, "Parent" %>
      <%= form.select :parent_id,
          options_for_select(
            [['None (root level)', nil]] + parent_options.map { |t| [t.full_path, t.id] },
            topology.parent_id
          ),
          {},
          class: "form-control" %>
      <small class="form-text">Nest under another topology to build a hierarchy.</small>
    </div>
  </div>

  <div class="form-panel">
    <h3 class="form-panel-title">Appearance</h3>

    <div class="form-group">
      <%= form.label :topology_type, "Type" %>
      <%= form.select :topology_type,
          options_for_select(
            Topology.topology_types.keys.map { |k| [k.humanize, k] },
            topology.topology_type
          ),
          {},
          class: "form-control" %>
      <small class="form-text">Predefined topologies are shared defaults. Custom are your own.</small>
    </div>

    <div class="form-group">
      <%= form.label :color, "Color" %>
      <div class="color-preview-row">
        <%= form.color_field :color, value: topology.color || '#d4953a', class: "form-control", style: "width: 60px; flex-shrink: 0;" %>
        <span class="topology-badge" style="--badge-color: <%= topology.color || '#d4953a' %>">
          <span class="topology-color-dot" style="background-color: <%= topology.color || '#d4953a' %>"></span>
          <%= topology.name.presence || 'Preview' %>
        </span>
      </div>
    </div>
  </div>
</div>

<% unless topology.new_record? %>
  <div class="form-panel" style="margin-top: 1rem;">
    <details>
      <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem 0;">
        Override Graph Settings
        <small style="font-weight: 400; color: var(--text-muted);">â€” customize graph for this topology</small>
      </summary>
      <div style="margin-top: 1rem;">
        <% overrides = @user.settings&.dig('topology_overrides', topology.id.to_s) || {} %>

        <div class="form-group">
          <%= form.label "topology_overrides[dag_mode]", "Layout Mode" %>
          <%= form.select "topology_overrides[dag_mode]",
              options_for_select([["Use default", ""], ["Tree", "td"], ["Force-directed", "free"]], overrides['dag_mode'] || ""),
              {}, class: "form-control" %>
        </div>

        <div class="form-group">
          <%= form.label "topology_overrides[show_ideas]", "Show Ideas" %>
          <%= form.select "topology_overrides[show_ideas]",
              options_for_select([["Use default", ""], ["Yes", "true"], ["No", "false"]], overrides.key?('show_ideas') ? overrides['show_ideas'].to_s : ""),
              {}, class: "form-control" %>
        </div>

        <div class="form-group">
          <%= form.label "topology_overrides[bloom_strength]", "Bloom Strength" %>
          <%= form.number_field "topology_overrides[bloom_strength]",
              value: overrides['bloom_strength'] || "",
              min: 0, max: 2, step: 0.1, class: "form-control",
              placeholder: "Leave blank for default" %>
        </div>

        <div class="form-group">
          <%= form.label "topology_overrides[fog_density]", "Fog Density" %>
          <%= form.number_field "topology_overrides[fog_density]",
              value: overrides['fog_density'] || "",
              min: 0, max: 0.05, step: 0.001, class: "form-control",
              placeholder: "Leave blank for default" %>
        </div>
      </div>
    </details>
  </div>
<% end %>

<div class="form-actions">
  <%= link_to "Cancel", topologies_path, class: "btn" %>
  <%= form.submit topology.new_record? ? "Create Topology" : "Update Topology", class: "btn btn-primary" %>
</div>
